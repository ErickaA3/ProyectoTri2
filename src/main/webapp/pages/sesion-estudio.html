<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi ProfesorIA - Sesión de Estudio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/styles-shared.css">
    <link rel="stylesheet" href="../css/sesion-estudio.css">
</head>
<body data-page="modo-estudio">

    <div id="navbar-container"></div>
    <div id="sidebar-container"></div>

    <!-- ================================================================
         PANTALLA DE CARGA (visible mientras genera)
    ================================================================ -->
    <div class="loading-screen" id="loadingScreen">
        <canvas id="loadingStars"></canvas>
        <div class="loading-content">
            <div class="loading-logo">
                <img src="../images/modo-estudio/modo-estudio-logo.png" alt="Modo Estudio">
            </div>
            <div class="loading-orb">
                <div class="loading-orb-ring r1"></div>
                <div class="loading-orb-ring r2"></div>
                <div class="loading-orb-ring r3"></div>
                <div class="loading-orb-core">
                    <i class="fas fa-brain"></i>
                </div>
            </div>
            <div class="loading-title">Generando tu sesión de estudio</div>
            <div class="loading-subtitle" id="loadingSubtitle">Analizando tu contenido...</div>
            <div class="loading-progress-bar">
                <div class="loading-progress-fill" id="loadingProgressFill"></div>
            </div>
            <div class="loading-steps" id="loadingSteps"></div>
        </div>
    </div>

    <!-- ================================================================
         PANTALLA DE RESULTADOS (visible después de generar)
    ================================================================ -->
    <main class="content" id="mainContent" style="display:none;">
        <canvas id="starsCanvas"></canvas>

        <!-- Header de la sesión -->
        <div class="se-header">
            <div class="se-header-left">
                <a href="../pages/modo-estudio.html" class="se-back-link">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <div>
                    <div class="se-title" id="seTitle">Sesión de Estudio</div>
                    <div class="se-meta" id="seMeta">4 tipos de contenido generados</div>
                </div>
            </div>
            <div class="se-session-badge">
                <i class="fas fa-check-circle"></i> Listo
            </div>
        </div>

        <!-- Tabs de navegación -->
        <div class="se-tabs" id="seTabs"></div>

        <!-- Contenido de cada tab -->
        <div class="se-panels" id="sePanels"></div>
    </main>

    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">Listo</span>
    </div>

    <script src="../js/components.js"></script>
    <script>
    // ================================================================
    // CONFIGURACIÓN DE MÓDULOS
    // ================================================================
    const MODULE_CONFIG = {
        flashcards: {
            label:    'Flashcards',
            icon:     'fa-layer-group',
            color:    '#2dd4bf',
            studyUrl: '../pages/flashcards.html',
            btnLabel: 'Estudiar flashcards',
            btnIcon:  'fa-play'
        },
        esquemas: {
            label:    'Esquema',
            icon:     'fa-project-diagram',
            color:    '#8b5cf6',
            studyUrl: null, // se renderiza aquí directamente
            btnLabel: 'Ver esquema completo',
            btnIcon:  'fa-expand'
        },
        examenes: {
            label:    'Examen',
            icon:     'fa-file-signature',
            color:    '#f59e0b',
            studyUrl: null, // depende del tipo (quiz o expert_exam)
            btnLabel: 'Iniciar examen',
            btnIcon:  'fa-bolt'
        },
        resumenes: {
            label:    'Resumen',
            icon:     'fa-file-alt',
            color:    '#ec4899',
            studyUrl: null, // se muestra inline
            btnLabel: 'Leer completo',
            btnIcon:  'fa-book-open'
        }
    };

    let flow    = null;
    let results = null;
    let activeTab = null;

    // ================================================================
    // FLOW MANAGER
    // ================================================================
    function getFlow() { return JSON.parse(sessionStorage.getItem('modoEstudioFlow') || 'null'); }

    // ================================================================
    // INIT — empieza en pantalla de carga, luego llama al servlet
    // ================================================================
    document.addEventListener('DOMContentLoaded', async () => {
        flow = getFlow();

        if (!flow || !flow.userId) {
            window.location.href = '../pages/modo-estudio.html';
            return;
        }

        initLoadingStars();
        renderLoadingSteps(flow.options);

        try {
            results = await generateSession(flow);
            sessionStorage.setItem('studyResults', JSON.stringify(results));
            await simulateFinish(); // pequeña pausa visual
            showResults(flow, results);
        } catch (err) {
            console.error('Error generando sesión:', err);
            showError(err.message);
        }
    });

    // ================================================================
    // LLAMADA AL SERVLET
    // ================================================================
    async function generateSession(flow) {
        const response = await fetch('/modo-estudio/generar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId:   flow.userId,
                options:  flow.options,
                dataType: flow.dataType,
                text:     flow.text,
                configs:  flow.configs
            })
        });

        if (!response.ok) throw new Error(`Error del servidor: ${response.status}`);
        const data = await response.json();
        if (!data.success) throw new Error(data.error || 'Error al generar contenido');
        return data.results;
    }

    // ================================================================
    // PANTALLA DE CARGA
    // ================================================================
    const STEP_LABELS = {
        flashcards: { label: 'Generando flashcards',  icon: 'fa-layer-group'    },
        esquemas:   { label: 'Creando esquema',        icon: 'fa-project-diagram'},
        examenes:   { label: 'Preparando examen',      icon: 'fa-file-signature' },
        resumenes:  { label: 'Redactando resumen',     icon: 'fa-file-alt'       }
    };

    function renderLoadingSteps(options) {
        const container = document.getElementById('loadingSteps');
        container.innerHTML = options.map(opt => `
            <div class="loading-step" id="lstep-${opt}">
                <div class="loading-step-icon"><i class="fas ${STEP_LABELS[opt]?.icon || 'fa-star'}"></i></div>
                <div class="loading-step-label">${STEP_LABELS[opt]?.label || opt}</div>
                <div class="loading-step-status" id="lstatus-${opt}">
                    <div class="loading-dot-spin"></div>
                </div>
            </div>
        `).join('');

        // Animar los pasos uno por uno
        let delay = 0;
        options.forEach(opt => {
            setTimeout(() => {
                document.getElementById('lstep-' + opt)?.classList.add('active');
                const subtitles = { flashcards:'Creando tarjetas de estudio...', esquemas:'Construyendo el esquema...', examenes:'Formulando las preguntas...', resumenes:'Redactando el resumen...' };
                document.getElementById('loadingSubtitle').textContent = subtitles[opt] || 'Procesando...';
                // Actualizar barra de progreso
                const pct = Math.round(((options.indexOf(opt) + 1) / options.length) * 85);
                document.getElementById('loadingProgressFill').style.width = pct + '%';
            }, delay);
            delay += 1800;
        });
    }

    function simulateFinish() {
        return new Promise(resolve => {
            document.getElementById('loadingSubtitle').textContent = '¡Todo listo!';
            document.getElementById('loadingProgressFill').style.width = '100%';
            // Marcar todos como completos
            document.querySelectorAll('.loading-step').forEach(s => {
                s.classList.add('done');
                const id = s.id.replace('lstep-', '');
                const st = document.getElementById('lstatus-' + id);
                if (st) st.innerHTML = '<i class="fas fa-check" style="color:#2dd4bf"></i>';
            });
            setTimeout(resolve, 800);
        });
    }

    function showError(msg) {
        document.getElementById('loadingSubtitle').textContent = 'Error: ' + msg;
        document.getElementById('loadingProgressFill').style.background = '#ef4444';
    }

    // ================================================================
    // PANTALLA DE RESULTADOS
    // ================================================================
    function showResults(flow, results) {
        // Ocultar loading, mostrar resultados
        document.getElementById('loadingScreen').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            initResultStars();
            buildUI(flow, results);
        }, 400);
    }

    function buildUI(flow, results) {
        // Header
        const successCount = flow.options.filter(o => results[o] && !results[o].error).length;
        document.getElementById('seTitle').textContent = results[flow.options[0]]?.title || 'Sesión de Estudio';
        document.getElementById('seMeta').textContent = `${successCount} ${successCount === 1 ? 'tipo generado' : 'tipos generados'} correctamente`;

        // Tabs
        const tabsEl   = document.getElementById('seTabs');
        const panelsEl = document.getElementById('sePanels');
        tabsEl.innerHTML = '';
        panelsEl.innerHTML = '';

        let firstTab = null;
        flow.options.forEach(opt => {
            const cfg = MODULE_CONFIG[opt];
            if (!cfg) return;
            const hasError = results[opt]?.error;

            // Tab
            const tab = document.createElement('div');
            tab.className = 'se-tab';
            tab.id = 'tab-' + opt;
            tab.innerHTML = `
                <i class="fas ${cfg.icon}"></i>
                <span>${cfg.label}</span>
                ${hasError ? '<span class="se-tab-err"><i class="fas fa-exclamation"></i></span>' : ''}
            `;
            tab.onclick = () => switchTab(opt);
            tab.style.setProperty('--tab-color', cfg.color);
            tabsEl.appendChild(tab);

            // Panel
            const panel = document.createElement('div');
            panel.className = 'se-panel';
            panel.id = 'panel-' + opt;
            panel.innerHTML = hasError
                ? buildErrorPanel(opt, results[opt].error)
                : buildPanel(opt, results[opt], flow.configs[opt]);
            panelsEl.appendChild(panel);

            if (!firstTab) firstTab = opt;
        });

        if (firstTab) switchTab(firstTab);
    }

    function switchTab(opt) {
        activeTab = opt;
        document.querySelectorAll('.se-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.se-panel').forEach(p => p.classList.remove('active'));
        document.getElementById('tab-' + opt)?.classList.add('active');
        document.getElementById('panel-' + opt)?.classList.add('active');
    }

    // ================================================================
    // BUILDERS DE PANELES
    // ================================================================
    function buildPanel(opt, data, config) {
        switch (opt) {
            case 'flashcards': return buildFlashcardsPanel(data);
            case 'esquemas':   return buildEsquemasPanel(data, config);
            case 'examenes':   return buildExamenesPanel(data, config);
            case 'resumenes':  return buildResumenPanel(data);
            default:           return `<p>Contenido no disponible</p>`;
        }
    }

    function buildErrorPanel(opt, error) {
        return `
            <div class="se-error-panel">
                <i class="fas fa-exclamation-triangle"></i>
                <div class="se-error-title">Error generando ${MODULE_CONFIG[opt]?.label}</div>
                <div class="se-error-msg">${error}</div>
                <button class="se-action-btn secondary" onclick="window.location.href='../pages/modo-estudio.html'">
                    <i class="fas fa-redo"></i> Volver a intentar
                </button>
            </div>
        `;
    }

    // — Flashcards —
    function buildFlashcardsPanel(data) {
        const cards = data.cards || [];
        const preview = cards.slice(0, 3).map(c => `
            <div class="se-fc-preview-card">
                <div class="se-fc-front">${c.front}</div>
                <div class="se-fc-divider"><i class="fas fa-arrow-down"></i></div>
                <div class="se-fc-back">${c.back}</div>
            </div>
        `).join('');

        return `
            <div class="se-panel-inner">
                <div class="se-panel-stats">
                    <div class="se-stat"><span class="se-stat-val">${cards.length}</span><span class="se-stat-lbl">tarjetas</span></div>
                    <div class="se-stat"><span class="se-stat-val">${data.title ? '✓' : '—'}</span><span class="se-stat-lbl">tema</span></div>
                </div>
                <div class="se-fc-preview">${preview}</div>
                ${cards.length > 3 ? `<div class="se-more-badge">+${cards.length - 3} tarjetas más</div>` : ''}
                <div class="se-actions">
                    <button class="se-action-btn primary" onclick="goStudy('flashcards')">
                        <i class="fas fa-play"></i> Estudiar flashcards
                    </button>
                    <button class="se-action-btn secondary" onclick="toggleFavorite('flashcards')">
                        <i class="fas fa-heart"></i> Guardar
                    </button>
                </div>
            </div>
        `;
    }

    // — Esquemas —
    function buildEsquemasPanel(data, config) {
        const tipoLabels = { jerarquico:'Jerárquico', conceptual:'Conceptual', timeline:'Línea del tiempo', 'causa-efecto':'Causa y efecto', ciclico:'Cíclico' };
        const tipo = config?.tipo || 'jerarquico';
        const root = data.rootNode;

        function renderNode(node, level = 0) {
            if (!node) return '';
            const children = (node.children || []).map(c => renderNode(c, level + 1)).join('');
            return `
                <div class="se-tree-node level-${Math.min(level, 3)}">
                    <div class="se-tree-label">${node.label || ''}</div>
                    ${children ? `<div class="se-tree-children">${children}</div>` : ''}
                </div>
            `;
        }

        return `
            <div class="se-panel-inner">
                <div class="se-panel-stats">
                    <div class="se-stat"><span class="se-stat-val">${tipoLabels[tipo] || tipo}</span><span class="se-stat-lbl">tipo</span></div>
                    <div class="se-stat"><span class="se-stat-val">${countNodes(root)}</span><span class="se-stat-lbl">nodos</span></div>
                </div>
                <div class="se-tree-container">
                    ${root ? renderNode(root) : '<p style="color:rgba(255,255,255,0.4)">Sin datos de esquema</p>'}
                </div>
                <div class="se-actions">
                    <button class="se-action-btn primary" onclick="goStudy('esquemas')">
                        <i class="fas fa-expand"></i> Ver pantalla completa
                    </button>
                    <button class="se-action-btn secondary" onclick="toggleFavorite('esquemas')">
                        <i class="fas fa-heart"></i> Guardar
                    </button>
                </div>
            </div>
        `;
    }

    function countNodes(node) {
        if (!node) return 0;
        return 1 + (node.children || []).reduce((s, c) => s + countNodes(c), 0);
    }

    // — Examen —
    function buildExamenesPanel(data, config) {
        const tipo = config?.tipo === 'expert_exam' ? 'Examen Experto' : 'Quiz Rápido';
        const icon = config?.tipo === 'expert_exam' ? 'fa-crown' : 'fa-bolt';
        const questions = data.questions || [];
        const diff = { facil:'Fácil', medio:'Medio', dificil:'Difícil' };

        return `
            <div class="se-panel-inner">
                <div class="se-panel-stats">
                    <div class="se-stat"><span class="se-stat-val">${questions.length}</span><span class="se-stat-lbl">preguntas</span></div>
                    <div class="se-stat"><span class="se-stat-val">${diff[config?.dificultad] || '—'}</span><span class="se-stat-lbl">dificultad</span></div>
                    ${config?.tipo === 'expert_exam' ? `<div class="se-stat"><span class="se-stat-val">${config.tiempoPorPregunta}s</span><span class="se-stat-lbl">/ pregunta</span></div>` : ''}
                </div>
                <div class="se-exam-preview">
                    <div class="se-exam-type-badge ${config?.tipo === 'expert_exam' ? 'expert' : ''}">
                        <i class="fas ${icon}"></i> ${tipo}
                    </div>
                    ${questions.slice(0, 2).map((q, i) => `
                        <div class="se-question-preview">
                            <div class="se-q-num">${i + 1}</div>
                            <div class="se-q-text">${q.question}</div>
                        </div>
                    `).join('')}
                    ${questions.length > 2 ? `<div class="se-more-badge">+${questions.length - 2} preguntas más</div>` : ''}
                </div>
                <div class="se-actions">
                    <button class="se-action-btn primary" onclick="goStudy('examenes')">
                        <i class="fas ${icon}"></i> Iniciar ${tipo}
                    </button>
                    <button class="se-action-btn secondary" onclick="toggleFavorite('examenes')">
                        <i class="fas fa-heart"></i> Guardar
                    </button>
                </div>
            </div>
        `;
    }

    // — Resumen —
    function buildResumenPanel(data) {
        const text = data.summaryText || '';
        // Convertir markdown básico a HTML
        const html = text
            .replace(/^## (.+)$/gm,  '<h3>$1</h3>')
            .replace(/^### (.+)$/gm, '<h4>$1</h4>')
            .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
            .replace(/^- (.+)$/gm,   '<li>$1</li>')
            .replace(/\n/g, '<br>');

        return `
            <div class="se-panel-inner">
                <div class="se-panel-stats">
                    <div class="se-stat"><span class="se-stat-val">${text.split(' ').length}</span><span class="se-stat-lbl">palabras</span></div>
                    <div class="se-stat"><span class="se-stat-val">${(text.match(/^## /gm) || []).length || 1}</span><span class="se-stat-lbl">secciones</span></div>
                </div>
                <div class="se-resumen-content">${html}</div>
                <div class="se-actions">
                    <button class="se-action-btn secondary" onclick="toggleFavorite('resumenes')">
                        <i class="fas fa-heart"></i> Guardar resumen
                    </button>
                </div>
            </div>
        `;
    }

    // ================================================================
    // ACCIONES
    // ================================================================
    function goStudy(opt) {
        const routes = {
            flashcards: '../pages/flashcards.html',
            esquemas:   '../pages/diagrams.html',
            examenes:   '../pages/quiz.html',
            resumenes:  '../pages/favoritos.html'
        };
        // Para examen experto, redirigir a exam.html
        if (opt === 'examenes' && flow?.configs?.examenes?.tipo === 'expert_exam') {
            window.location.href = '../pages/exam.html';
            return;
        }
        if (routes[opt]) window.location.href = routes[opt];
    }

    function toggleFavorite(opt) {
        const contentId = results?.[opt]?.id;
        if (!contentId) { showToast('Contenido no disponible'); return; }
        showToast('Guardado en favoritos');
        // TODO: llamar al endpoint toggleFavorite cuando esté disponible
        // fetch('/content/favorite', { method:'PUT', body: JSON.stringify({ contentId, userId: flow.userId, isFavorite: true }) })
    }

    // ================================================================
    // TOAST
    // ================================================================
    function showToast(msg) {
        const t = document.getElementById('toast');
        document.getElementById('toastMessage').textContent = msg;
        t.classList.add('show');
        clearTimeout(t._t);
        t._t = setTimeout(() => t.classList.remove('show'), 3000);
    }

    // ================================================================
    // STARS — loading screen
    // ================================================================
    function initLoadingStars() {
        const canvas = document.getElementById('loadingStars');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        const stars = Array.from({length:200}, () => ({
            x:Math.random()*canvas.width, y:Math.random()*canvas.height,
            size:Math.random()*2+0.2, speedX:(Math.random()-0.5)*0.08, speedY:(Math.random()-0.5)*0.08,
            opacity:Math.random()*0.5+0.1, opacityChange:(Math.random()-0.5)*0.01,
            color:['#ffffff','#ffe9c4','#d4f1ff','#c4b5fd'][Math.floor(Math.random()*4)]
        }));
        function animate() {
            if (!document.getElementById('loadingStars')) return;
            ctx.clearRect(0,0,canvas.width,canvas.height);
            stars.forEach(s => {
                s.x+=s.speedX; s.y+=s.speedY;
                if(s.x<0)s.x=canvas.width; if(s.x>canvas.width)s.x=0;
                if(s.y<0)s.y=canvas.height; if(s.y>canvas.height)s.y=0;
                s.opacity+=s.opacityChange; if(s.opacity<=0.05||s.opacity>=0.7)s.opacityChange*=-1;
                ctx.beginPath(); ctx.arc(s.x,s.y,s.size,0,Math.PI*2);
                ctx.fillStyle=s.color; ctx.globalAlpha=s.opacity; ctx.fill();
            });
            ctx.globalAlpha=1; requestAnimationFrame(animate);
        }
        animate();
    }

    function initResultStars() {
        const canvas = document.getElementById('starsCanvas');
        const ctx = canvas.getContext('2d'), content = document.getElementById('mainContent');
        function resize() { canvas.width = content.offsetWidth; canvas.height = Math.max(content.scrollHeight, window.innerHeight); }
        resize();
        const stars = Array.from({length:120}, () => ({
            x:Math.random()*canvas.width, y:Math.random()*canvas.height,
            size:Math.random()*1.8+0.2, speedX:(Math.random()-0.5)*0.08, speedY:(Math.random()-0.5)*0.08,
            opacity:Math.random()*0.35+0.05, opacityChange:(Math.random()-0.5)*0.01,
            color:['#ffffff','#c4b5fd','#aaddff'][Math.floor(Math.random()*3)]
        }));
        function animate() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            stars.forEach(s => {
                s.x+=s.speedX; s.y+=s.speedY;
                if(s.x<0)s.x=canvas.width; if(s.x>canvas.width)s.x=0;
                if(s.y<0)s.y=canvas.height; if(s.y>canvas.height)s.y=0;
                s.opacity+=s.opacityChange; if(s.opacity<=0.02||s.opacity>=0.5)s.opacityChange*=-1;
                ctx.beginPath(); ctx.arc(s.x,s.y,s.size,0,Math.PI*2);
                ctx.fillStyle=s.color; ctx.globalAlpha=s.opacity; ctx.fill();
            });
            ctx.globalAlpha=1; requestAnimationFrame(animate);
        }
        animate(); window.addEventListener('resize',resize);
    }
    </script>

</body>
</html>